# Session 2025-09-13 — Scope: Review @memo.md and suggest robustness improvements for PDF highlighter

- 10:00 Ran: `rg --files -S | sed -n '1,200p'`
  Output:
  ```text
  icpc-2022-zhu.pdf
  kbse-202405-kamiya.highlighted.pdf
  kbse-202405-kamiya.pdf
  LICENSE.txt
  pyproject.toml
  README.md
  memo.md
  AGENTS.md
  tests/__init__.py
  tests/test_group_bboxes.py
  tests/test_text_normalization.py
  dev-notes/discussion.md
  dev-notes/session-2025-09-13.md
  src/pdfhl/__about__.py
  src/pdfhl/__init__.py
  src/pdfhl/pdfhl.py
  ```
  Why: Inventory repository and verify `memo.md` presence
  Result: Confirmed `memo.md` exists at project root

- 10:02 Ran: `sed -n '1,220p' memo.md`
  Output (excerpt):
  ```text
  ... pdfhl --dry-run --report json --text "本研究では，ソースコード..."
  ... [ERROR] failed to save PDF: save to original must be incremental
  ... work-around: chained outputs kbse-202405-kamiya.hl1.pdf -> ... -> .hl8.pdf
  ```
  Why: Review prior run to extract failure modes and workflows
  Result: Found save-over-same-file error and multi-pass usage patterns

- 10:06 Note: Save current improvement list to log
  Output:
  ```text
  改良案（エラー・手戻り低減のため）

  1) 保存・I/O の堅牢化
  - 入出力同一時の自動インクリメンタル保存（またはエラーメッセージで明示し --inplace へ誘導）
  - 一時ファイル経由のセーフセーブ（失敗時の原本保護）
  - 複数ハイライトのワンパス適用（レシピ/複数 --text 対応）

  2) マッチングの堅牢化（改行・空白・語形揺れ）
  - `--flex-space`（`\s*`）など空白許容度のプリセット追加
  - 行/ブロック境界に区切り挿入で行跨ぎマッチの成功率向上
  - 行末ハイフネーションの吸収 `--normalize-hyphenation`
  - 日本語向け正規化（句読点・長音・半全角・カナひらがな）オプション
  - 句読点・記号無視 `--ignore-punct`

  3) 複数一致・選択制御
  - `--nth N`, `--page P`, `--first-only`
  - `--from-report` で JSON レポートから再実行

  4) アノテーション適用の安定化
  - `y_tol` の動的化（スパン高さ等に基づく）
  - 回転/CropBox 対応の座標補正
  - フォールバック描画時の色・不透明度・ラベルの完全適用と詳細ログ

  5) CLI/UX の改善
  - 一括レシピ（JSON）での適用
  - 複数一致時のガイダンス強化（具体オプションを提示）
  - 色指定の柔軟化（#RRGGBB / r,g,b）
  - `--quiet`, `--verbose` のログ制御

  6) 抽出ロバスト性の向上
  - `extractRAWDICT` 失敗時の `get_text('words')` フォールバック
  - 空文字/CIDマップ問題の警告と代替抽出ヒント

  7) 開発・検証
  - 同一入出力保存・複数一致・行跨ぎ・ハイフネーション・日本語句読点揺れの回帰テスト
  - `--report json` スキーマの明記とサンプル
  ```

- 10:08 Note: Incremental save vs non-inplace policy
  Output:
  ```text
  提案: デフォルトは「入力PDFは変更しない」を --help に明記し、入出力同一パスは拒否。
  さらに、明示的に上書きしたい場合のみ `--inplace` を導入し、
  その際は incremental save（または saveIncr）で安全に上書き。

  メリット: 既定で安全（原本保護）、ユーザーの多段適用ワークフロー時の「同一入出力での保存エラー」を防止。
  ```

## Implementation

- 10:15 Ran: `apply_patch` (introduce --inplace, refuse same-path saves by default)
  Output (excerpt):
  ```text
  M src/pdfhl/pdfhl.py
  ```
  Why: Defaultで入力PDFを変更しない方針を実装し、--inplace 時のみインクリメンタル保存
  Result: 
  - argparse: `--inplace` を追加し `--output` と排他
  - 説明文: 「Default: never modifies the input PDF...」を --help に明記
  - 保存: `--inplace` なら `doc.save(..., incremental=True)`、それ以外は別ファイル保存
  - 同一パス指定かつ非inplaceはエラーでガイダンス表示

- 10:28 Ran: `apply_patch` (add multi-pattern recipe mode)
  Output (excerpt):
  ```text
  M src/pdfhl/pdfhl.py
  ```
  Why: 複数ハイライトを1パスで適用するため JSON レシピ対応を追加
  Result:
  - `--recipe` 追加（JSON配列 or {items:[...]})
  - `process_recipe` 実装：PDFを一度開いて全itemを適用し一度だけ保存
  - 色指定: `_parse_color` で name/#RRGGBB/r,g,b に対応
  - レポート: `--report json` で itemsごとのヒット情報を集約出力
  - 既存単発モードは従来通り（`--text/--pattern`）

- 10:40 Ran: `apply_patch` (unify code paths via recipe)
  Output (excerpt):
  ```text
  M src/pdfhl/pdfhl.py
  ```
  Why: レシピ未指定でも内部的に単一アイテムのレシピを生成し、共通処理に統一
  Result:
  - main: 単発モードも `process_recipe` を使用
  - `process_recipe`: `report_context` と `compat_single_report` を追加し、
    単発モードの JSON 出力互換（従来のフラット形式）を維持

- 10:48 Ran: `apply_patch` (deprecate process_file, route to recipe)
  Output (excerpt):
  ```text
  M src/pdfhl/pdfhl.py
  ```
  Why: デッドコード化した `process_file` を互換用シムに置き換え、共通実装に集約
  Result: `process_file` -> 単一アイテムレシピを生成して `process_recipe` を呼ぶ

- 10:58 Ran: `apply_patch` (remove --inplace, enforce new-file only)
  Output (excerpt):
  ```text
  M src/pdfhl/pdfhl.py
  ```
  Why: 別インスタンスで --inplace が使えない事例に対応し、仕様を「常に新しいPDFを生成」に簡素化
  Result:
  - CLIから `--inplace` を削除、--help も更新（入力PDFは変更しない）
  - 保存は常に新規ファイルへ。入出力同一はエラーで拒否
  - レポートの `output` は新規出力パスに統一
